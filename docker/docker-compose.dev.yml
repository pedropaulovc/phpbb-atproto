services:
  phpbb:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    volumes:
      - ../ext:/var/www/html/ext/phpbb/atproto:cached
      - ../tests:/var/www/html/tests:cached
      - ../vendor:/var/www/html/vendor:cached
      - ../composer.json:/var/www/html/composer.json:cached
      - ../phpunit.xml:/var/www/html/phpunit.xml:cached
      - ../phpunit.integration.xml:/var/www/html/phpunit.integration.xml:cached
      - ../phpstan.neon:/var/www/html/phpstan.neon:cached
      - ../.php-cs-fixer.php:/var/www/html/.php-cs-fixer.php:cached
    environment:
      XDEBUG_MODE: debug
      XDEBUG_CONFIG: client_host=host.docker.internal
      # Test encryption keys for local development only - DO NOT use in production
      ATPROTO_TOKEN_ENCRYPTION_KEYS: '{"v1":"dGVzdGtleXRlc3RrZXl0ZXN0a2V5dGVzdGtleXRlc3Q="}'
      ATPROTO_TOKEN_ENCRYPTION_KEY_VERSION: v1

  db:
    ports:
      - "3306:3306"

  # Test database for integration tests
  db-test:
    image: mysql:8.0
    container_name: phpbb-mysql-test
    environment:
      MYSQL_ROOT_PASSWORD: testroot
      MYSQL_DATABASE: phpbb_test
      MYSQL_USER: phpbb_test
      MYSQL_PASSWORD: test_password
    command: --default-authentication-plugin=mysql_native_password
    tmpfs:
      - /var/lib/mysql
