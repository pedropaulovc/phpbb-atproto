services:
    # Token encryption service
    phpbb.atproto.token_encryption:
        class: phpbb\atproto\auth\token_encryption

    # DPoP service for token binding (AT Protocol requirement)
    phpbb.atproto.auth.dpop_service:
        class: phpbb\atproto\auth\dpop_service
        arguments:
            - '@dbal.conn'
            - '@phpbb.atproto.token_encryption'
            - '%core.table_prefix%'

    # DID resolution service
    phpbb.atproto.did_resolver:
        class: phpbb\atproto\services\did_resolver
        arguments:
            - '@cache.driver'
            - '%atproto.did_cache_ttl%'

    # OAuth client for AT Protocol
    phpbb.atproto.oauth_client:
        class: phpbb\atproto\auth\oauth_client
        arguments:
            - '@phpbb.atproto.did_resolver'
            - '@phpbb.atproto.auth.dpop_service'
            - '%atproto.client_id%'
            - '%atproto.redirect_uri%'

    # Token manager for storage and refresh
    phpbb.atproto.token_manager:
        class: phpbb\atproto\services\token_manager
        arguments:
            - '@dbal.conn'
            - '@phpbb.atproto.token_encryption'
            - '@phpbb.atproto.oauth_client'
            - '%core.table_prefix%'
            - '%atproto.token_refresh_buffer%'

    # OAuth controller
    phpbb.atproto.controller.oauth:
        class: phpbb\atproto\controller\oauth_controller
        arguments:
            - '@controller.helper'
            - '@language'
            - '@phpbb.atproto.oauth_client'
            - '@request'
            - '@template'
            - '@phpbb.atproto.token_manager'
            - '@user'

    # Auth event listener
    phpbb.atproto.event.auth_listener:
        class: phpbb\atproto\event\auth_listener
        arguments:
            - '@phpbb.atproto.token_manager'
        tags:
            - { name: event.listener }

    # UI event listener (language loading and template variables)
    phpbb.atproto.event.ui_listener:
        class: phpbb\atproto\event\ui_listener
        arguments:
            - '@controller.helper'
            - '@language'
            - '@template'
            - '@user'
        tags:
            - { name: event.listener }

    # Phase 2 services (Write Path) - to be implemented
    # phpbb.atproto.pds_client
    # phpbb.atproto.uri_mapper
    # phpbb.atproto.queue_manager
    # phpbb.atproto.record_builder

parameters:
    # These values can be overridden in phpBB's config/development.php or production.php
    atproto.client_id: 'http://localhost:8080/'
    atproto.redirect_uri: 'http://localhost:8080/app.php/atproto/callback'
    atproto.token_refresh_buffer: 300
    atproto.did_cache_ttl: 3600
