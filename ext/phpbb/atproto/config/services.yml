services:
    # Token encryption service
    phpbb.atproto.token_encryption:
        class: phpbb\atproto\auth\token_encryption

    # DID resolution service
    phpbb.atproto.did_resolver:
        class: phpbb\atproto\services\did_resolver
        arguments:
            - '@cache.driver'
            - '%atproto.did_cache_ttl%'

    # OAuth client for AT Protocol
    phpbb.atproto.oauth_client:
        class: phpbb\atproto\auth\oauth_client
        arguments:
            - '@phpbb.atproto.did_resolver'
            - '%atproto.client_id%'
            - '%atproto.redirect_uri%'

    # Token manager for storage and refresh
    phpbb.atproto.token_manager:
        class: phpbb\atproto\services\token_manager
        arguments:
            - '@dbal.conn'
            - '@phpbb.atproto.token_encryption'
            - '@phpbb.atproto.oauth_client'
            - '%core.table_prefix%'
            - '%atproto.token_refresh_buffer%'

    # OAuth callback controller
    phpbb.atproto.controller.oauth:
        class: phpbb\atproto\controller\oauth_controller
        arguments:
            - '@phpbb.atproto.oauth_client'
            - '@phpbb.atproto.token_manager'

    # Auth event listener
    phpbb.atproto.event.auth_listener:
        class: phpbb\atproto\event\auth_listener
        arguments:
            - '@phpbb.atproto.token_manager'
        tags:
            - { name: event.listener }

    # Phase 2 services (Write Path) - to be implemented
    # phpbb.atproto.pds_client
    # phpbb.atproto.uri_mapper
    # phpbb.atproto.queue_manager
    # phpbb.atproto.record_builder

parameters:
    atproto.client_id: '%env(ATPROTO_CLIENT_ID)%'
    atproto.redirect_uri: ~
    atproto.token_refresh_buffer: 300
    atproto.did_cache_ttl: 3600
